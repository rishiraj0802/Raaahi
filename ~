const app = require('express')()
const nconf = require('nconf')
const { exec } = require('child_process')
const port = nconf.get('port')
const { initializeDB, addDummyUsers } = require('./db/db.js');

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.get('/api/addDummyUsers', async(req, res) => {
  await addDummyUsers(ip);
  res.send('Dummy users added to the db')
})
app.post('/addUser', (req, res) => {})
app.delete('/removeUser', (req, res) => {})
app.post('/search', (req, res) => {})
app.post('/cleanup', (req, res) => {})
app.listen(3000, async() => {
  try{
    exec("sudo docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' database",(err,ip,stderr)=>{
      if(err){
        console.log(`ERROR: ${err} while trying to fetch docker ip, make sure the instance is running!`)
      }
      else{
        await initializeDB(ip)   
        console.log(`Server running on port ${port}`)
      }
    })
  }
  catch(err){
    console.log(`Error while establishing connection to the database:${err}`)
  }
})
